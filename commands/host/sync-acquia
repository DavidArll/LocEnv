#!/usr/bin/env bash
set -e

# Configuraci√≥n de API de Acquia
ACQUIA_API_KEY=$(ddev exec printenv ACQUIA_API_KEY)
ACQUIA_API_SECRET=$(ddev exec printenv ACQUIA_API_SECRET)
PROJECT_ID=$(ddev exec printenv ACQUIA_PROJECT_ID)


# Obtener token de autenticaci√≥n desde Acquia Cloud API
echo "üîÑ Obteniendo token de autenticaci√≥n..."
TOKEN_RESPONSE=$(curl -s -X POST "https://accounts.acquia.com/api/auth/oauth/token" \
  -d "client_id=$ACQUIA_API_KEY" \
  -d "client_secret=$ACQUIA_API_SECRET" \
  -d "grant_type=client_credentials")

TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')

if [[ -z "$TOKEN" || "$TOKEN" == "null" ]]; then
  echo "‚ùå Error: No se pudo obtener el token de autenticaci√≥n."
  exit 1
fi

echo "‚úÖ Token obtenido exitosamente."

# Obtener informaci√≥n del proyecto en Acquia
echo "üîÑ Obteniendo informaci√≥n del proyecto en Acquia..."
PROJECT_RESPONSE=$(curl -s -X GET "https://cloud.acquia.com/api/applications/$PROJECT_ID" \
  -H "Authorization: Bearer $TOKEN" -H "Accept: application/json")

PROJECT_NAME=$(echo "$PROJECT_RESPONSE" | jq -r '.name')
PROJECT_HOSTING=$(echo "$PROJECT_RESPONSE" | jq -r '.hosting')
PROJECT_SUBSCRIPTION=$(echo "$PROJECT_RESPONSE" | jq -r '.subscription')

echo "üîπ Proyecto: $PROJECT_NAME"
echo "üîπ Tipo de hosting: $PROJECT_HOSTING"
echo "üîπ Suscripci√≥n: $PROJECT_SUBSCRIPTION"

# Obtener lista de entornos disponibles (dev, test, prod)
echo "üîÑ Obteniendo lista de entornos..."
ENVIRONMENTS_RESPONSE=$(curl -s -X GET "https://cloud.acquia.com/api/applications/$PROJECT_ID/environments" \
  -H "Authorization: Bearer $TOKEN" -H "Accept: application/json")

ENVIRONMENTS=$(echo "$ENVIRONMENTS_RESPONSE" | jq -r '.data[] | "\(.id) - \(.label) - \(.domain)"')

if [[ -z "$ENVIRONMENTS" ]]; then
  echo "‚ùå No se encontraron entornos disponibles."
  exit 1
fi

echo "‚úÖ Entornos disponibles en Acquia:"
echo "$ENVIRONMENTS"

# Obtener sitios en cada entorno
echo "üîÑ Obteniendo sitios en cada entorno..."
for ENV_ID in $(echo "$ENVIRONMENTS" | awk '{print $1}'); do
  SITE_RESPONSE=$(curl -s -X GET "https://cloud.acquia.com/api/environments/$ENV_ID" \
    -H "Authorization: Bearer $TOKEN" -H "Accept: application/json")

  SITE_NAME=$(echo "$SITE_RESPONSE" | jq -r '.name')
  SITE_URL=$(echo "$SITE_RESPONSE" | jq -r '.domain')

  echo "üîπ Sitio: $SITE_NAME"
  echo "üîπ URL: $SITE_URL"
done

echo "‚úÖ Prueba de conexi√≥n a la API de Acquia completada."
